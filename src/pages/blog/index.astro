---
// src/pages/blog/index.astro
export const prerender = false; // Mode Server agar debug terlihat realtime

import Base from "@/layouts/Base.astro";

let posts = [];
let debugMessage = "";
let rawDataStatus = ""; // Untuk cek status mentah

try {
  const SCRIPT_URL = import.meta.env.PUBLIC_GOOGLE_SCRIPT_URL;
  
  // 1. Cek URL
  console.log("---------------------------------------------------");
  console.log("DEBUG BLOG: Memulai Fetch Data...");
  
  if (!SCRIPT_URL) {
    throw new Error("URL API TIDAK DITEMUKAN di file .env");
  }

  // 2. Fetch Data
  // Ganti 'read' jadi 'get_all'
  const response = await fetch(`${SCRIPT_URL}?action=get_all&table=tbl_posts`);
  const result = await response.json();

  // Simpan status untuk ditampilkan di UI jika perlu
  rawDataStatus = result.status; 

  console.log("DEBUG STATUS API:", result.status);
  
  // 3. Logika Jika Sukses vs Gagal
  if (result.status === "success") {
    
    // Tampilkan contoh data mentah pertama untuk pengecekan
    if (result.data && result.data.length > 0) {
        console.log("DEBUG CONTOH DATA (Item 0):", JSON.stringify(result.data[0]));
    } else {
        console.log("DEBUG: Data array kosong []");
    }

    // Filter Data (Case Insensitive)
    posts = result.data.filter((p) => {
        // Pastikan kolom 'status' ada, lalu kecilkan hurufnya
        const st = p.status ? p.status.toString().toLowerCase() : ""; 
        return st === "published";
    });

    console.log(`DEBUG: Ditemukan ${result.data.length} total baris. ${posts.length} baris statusnya 'published'.`);

    // Sort Descending (Terbaru di atas)
    posts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

  } else {
    // Jika Status bukan "success" (misal "error")
    console.error("DEBUG API ERROR:", result.message);
    debugMessage = `Google Sheets Menolak: ${result.message}`;
  }

} catch (error) {
  console.error("DEBUG SYSTEM ERROR:", error);
  debugMessage = `System Error: ${error.message}`;
}

const title = "Blog Sekolah";
const description = "Berita & Artikel Terbaru";
---

<Base title={title} description={description}>
  <section class="section pt-14 pb-10">
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-8">Berita Sekolah</h1>
        
        {/* === AREA DEBUGGING (Akan muncul jika tidak ada postingan) === */}
        {posts.length === 0 && (
            <div class="bg-slate-50 border border-slate-200 p-6 rounded-xl mb-8 text-center max-w-2xl mx-auto">
                <div class="inline-flex items-center justify-center w-12 h-12 bg-red-100 text-red-600 rounded-full mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">Data Tidak Muncul</h3>
                <p class="text-slate-500 mb-4">Belum ada berita yang berstatus <strong>"published"</strong> atau terjadi kesalahan koneksi.</p>
                
                {/* Detail Error Teknis */}
                <div class="bg-slate-900 text-slate-200 text-xs font-mono p-4 rounded text-left overflow-x-auto">
                    <p class="font-bold text-yellow-400 mb-2">Diagnostic Info:</p>
                    <p>API Status: <span class="text-green-400">{rawDataStatus || 'Unknown'}</span></p>
                    <p>Error Message: <span class="text-red-400">{debugMessage || '-'}</span></p>
                    <p class="mt-2 text-slate-500">Cek Terminal VS Code untuk log lengkap.</p>
                </div>
            </div>
        )}

        {/* === GRID POSTINGAN === */}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {posts.map((post) => (
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition group h-full flex flex-col">
                    {/* Thumbnail */}
                    <a href={`/blog/${post.slug}`} class="block h-48 bg-slate-100 relative overflow-hidden">
                         {post.thumbnail ? (
                            <img src={post.thumbnail} alt={post.title} class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" loading="lazy" />
                         ) : (
                            <div class="flex items-center justify-center h-full text-slate-400 bg-slate-50">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-50"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                            </div>
                         )}
                         <div class="absolute top-3 left-3">
                             <span class="bg-white/90 backdrop-blur text-[10px] font-bold px-2 py-1 rounded text-indigo-600 border border-indigo-100 uppercase tracking-wide">
                                {post.categories ? post.categories.split(',')[0] : 'Berita'}
                             </span>
                         </div>
                    </a>

                    {/* Content */}
                    <div class="p-5 flex-1 flex flex-col">
                        <div class="text-xs text-slate-400 mb-2 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                            {new Date(post.created_at).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}
                        </div>
                        
                        <h3 class="text-lg font-bold text-slate-800 mb-3 leading-snug hover:text-indigo-600 transition">
                            <a href={`/blog/${post.slug}`}>
                                {post.title}
                            </a>
                        </h3>
                        
                        <p class="text-slate-500 text-sm line-clamp-3 mb-4 flex-1">
                            {post.excerpt || post.content.replace(/<[^>]*>?/gm, '').substring(0, 100) + '...'}
                        </p>

                        <a href={`/blog/${post.slug}`} class="text-sm font-semibold text-indigo-600 hover:text-indigo-700 inline-flex items-center gap-1 mt-auto">
                            Baca Selengkapnya
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                        </a>
                    </div>
                </div>
            ))}
        </div>
    </div>
  </section>
</Base>