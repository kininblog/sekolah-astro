---
// src/pages/blog/[slug].astro

// 1. UBAH KE MODE SERVER (SSR)
// Agar halaman ini dibuat dadakan saat user mengeklik link
export const prerender = false;

import Base from "@/layouts/Base.astro";
import { marked } from "marked";

// 2. TANGKAP SLUG DARI URL
const { slug } = Astro.params;

// 3. FETCH DATA DARI GOOGLE SHEETS
let post = null;
try {
    const SCRIPT_URL = import.meta.env.PUBLIC_GOOGLE_SCRIPT_URL;
    
    // Kita fetch semua post lalu cari yang slug-nya cocok
    // (Cache 1 menit agar tidak boros kuota Google)
    const response = await fetch(`${SCRIPT_URL}?action=get_all&table=tbl_posts`);
    
    // Set Cache Header agar ngebut (disimpan di CDN Netlify selama 60 detik)
    Astro.response.headers.set('Cache-Control', 'public, max-age=60, s-maxage=60');

    const result = await response.json();

    if (result.status === 'success' && Array.isArray(result.data)) {
        // Cari postingan yang slug-nya sama dengan URL
        post = result.data.find((p) => p.slug === slug);
    }
} catch (error) {
    console.error("Gagal mengambil postingan:", error);
}

// 4. JIKA POSTINGAN TIDAK DITEMUKAN -> 404
if (!post) {
    return Astro.redirect('/404');
}

// 5. FORMAT CONTENT (Markdown to HTML)
const content = marked.parse(post.content || "");
---

<Base title={post.title} description={post.summary} image={post.image_url}>
  <section class="section pt-14">
    <div class="container">
      <div class="row justify-center">
        <article class="col-12 lg:col-8">
            
            {/* Header Artikel */}
            <div class="text-center mb-12">
                <span class="text-sm font-bold text-primary uppercase tracking-wider mb-2 block">
                    {post.category || "Berita Sekolah"}
                </span>
                <h1 class="h2 mb-4">{post.title}</h1>
                <ul class="flex justify-center items-center space-x-4 text-text/60 text-sm">
                    <li class="flex items-center">
                        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        {new Date(post.created_at).toLocaleDateString("id-ID", {
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                        })}
                    </li>
                    <li class="flex items-center">
                        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        {post.author || "Admin"}
                    </li>
                </ul>
            </div>

            {/* Gambar Utama */}
            {post.image_url && (
                <div class="rounded-2xl overflow-hidden mb-10 shadow-lg aspect-video">
                    <img
                        src={post.image_url}
                        alt={post.title}
                        class="w-full h-full object-cover"
                        width={800}
                        height={450}
                    />
                </div>
            )}

            {/* Isi Artikel (HTML dari Markdown) */}
            <div class="content prose prose-lg max-w-none prose-headings:font-bold prose-a:text-primary hover:prose-a:text-primary/80">
                <div set:html={content} />
            </div>

            {/* Tombol Kembali */}
            <div class="mt-12 pt-8 border-t border-border">
                <a href="/blog" class="btn btn-outline-primary">
                    ‚Üê Kembali ke Berita
                </a>
            </div>

        </article>
      </div>
    </div>
  </section>
</Base>