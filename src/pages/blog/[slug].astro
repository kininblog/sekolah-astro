---
// src/pages/blog/[slug].astro

// 1. WAJIB ADA: Agar fungsi getStaticPaths di bawah dijalankan
export const prerender = true;

import Base from "@/layouts/Base.astro";

// --- FUNGSI UTAMA SSG ---
export async function getStaticPaths() {
  let posts = [];
  
  try {
    const SCRIPT_URL = import.meta.env.PUBLIC_GOOGLE_SCRIPT_URL;
    // Menggunakan action=get_all
    const response = await fetch(`${SCRIPT_URL}?action=get_all&table=tbl_posts`);
    const result = await response.json();
    
    if (result.status === "success") {
      // Filter hanya status published
      posts = result.data.filter(p => {
         const status = p.status ? p.status.toString().toLowerCase() : "";
         return status === 'published';
      });
    }
  } catch (error) {
    console.error("Gagal mengambil paths:", error);
  }

  // Petakan setiap postingan menjadi halaman sendiri
  return posts.map((post) => ({
    params: { slug: post.slug }, 
    props: { post },
  }));
}
// ------------------------

const { post } = Astro.props;

// Safety Check: Jika post tidak ditemukan (misal akses langsung url ngawur)
if (!post) {
  return Astro.redirect('/404');
}

const { title, content, thumbnail, created_at, category, categories, seo_title, seo_desc } = post;

// Logic Kategori: Ambil 'category' atau 'categories' (jaga-jaga nama kolom beda), lalu ambil yang pertama jika ada koma
const displayCategory = (category || categories || 'Berita Sekolah').split(',')[0].trim();
---

<Base 
   title={seo_title || title} 
   meta_title={seo_title || title}
   description={seo_desc || title}
   image={thumbnail}
>
  <section class="section pt-10 pb-20 bg-white">
    <div class="container">
      <div class="max-w-4xl mx-auto">
        
        {/* Header Artikel */}
        <div class="text-center mb-10">
           {/* Badge Kategori */}
           <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-50 border border-indigo-100 text-indigo-700 text-xs font-bold uppercase tracking-widest mb-6">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
              {displayCategory}
           </div>

           <h1 class="text-3xl md:text-5xl font-extrabold text-slate-900 mb-6 leading-tight">
             {title}
           </h1>

           <div class="flex items-center justify-center gap-4 text-slate-500 text-sm">
             <span class="flex items-center gap-1.5">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                {created_at ? new Date(created_at).toLocaleDateString('id-ID', { weekday:'long', day:'numeric', month:'long', year:'numeric' }) : '-'}
             </span>
           </div>
        </div>

        {/* Featured Image */}
        {thumbnail && (
          <div class="rounded-2xl overflow-hidden mb-12 shadow-xl shadow-slate-200 border border-slate-100">
            <img 
              src={thumbnail} 
              alt={title} 
              class="w-full h-auto object-cover max-h-[500px]" 
            />
          </div>
        )}

        {/* Konten Artikel */}
        <div class="prose prose-lg prose-slate max-w-none 
            prose-headings:font-bold prose-headings:text-slate-800 
            prose-p:text-slate-600 prose-p:leading-relaxed
            prose-a:text-indigo-600 prose-a:no-underline hover:prose-a:underline
            prose-img:rounded-xl prose-img:shadow-lg
            prose-blockquote:border-indigo-500 prose-blockquote:bg-indigo-50/50 prose-blockquote:py-1 prose-blockquote:px-4 prose-blockquote:rounded-r-lg
        ">
            <article set:html={content} />
        </div>

      </div>
    </div>
  </section>
</Base>