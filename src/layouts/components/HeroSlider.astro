---
// src/components/HeroSlider.astro

import 'swiper/css';

let slides = [];

try {
    const SCRIPT_URL = import.meta.env.PUBLIC_GOOGLE_SCRIPT_URL;
    const response = await fetch(`${SCRIPT_URL}?action=get_all&table=tbl_sliders`);
    const result = await response.json();

    if (result.status === 'success' && Array.isArray(result.data) && result.data.length > 0) {
        slides = result.data
            .filter(item => item.active === 'Aktif')
            .sort((a, b) => (Number(a.order) || 0) - (Number(b.order) || 0));
    }
} catch (error) {
    console.error("Gagal mengambil data slider:", error);
}

// FALLBACK DATA
if (slides.length === 0) {
    slides = [
        {
            image_url: "https://cdn.prod.website-files.com/68e0f069e7077842f6665fd3/68e34fd9d64cd858d3f468e1_hero-img-p-2000.webp",
            title_small: "Selamat Datang di",
            title_big: "SEKOLAH KAMI",
            description: "Mewujudkan generasi cerdas, berkarakter, dan berdaya saing global.",
            button_text: "Tentang Kami",
            button_link: "#profil"
        },
        {
            image_url: "https://images.unsplash.com/photo-1523050854058-8df90110c9f1?q=80&w=1920&auto=format&fit=crop",
            title_small: "Fasilitas Modern",
            title_big: "RUANG BELAJAR",
            description: "Lingkungan yang nyaman dan interaktif untuk mendukung potensi maksimal setiap siswa.",
            button_text: "Lihat Fasilitas",
            button_link: "#fasilitas"
        }
    ];
}
---

<section class="relative w-full h-[100dvh] min-h-[600px] bg-slate-900 overflow-hidden" aria-label="Hero Slider">
    
    <div class="swiper myHeroSwiper w-full h-full">
        <div class="swiper-wrapper">
            
            {slides.map((slide, index) => (
                <div class="swiper-slide relative flex items-center justify-center overflow-hidden">
                    
                    {/* Background Image - LCP OPTIMIZED */}
                    <div class="absolute inset-0 w-full h-full z-0">
                        <img 
                            src={slide.image_url} 
                            alt={slide.title_big || "Banner Sekolah"} 
                            width="1920" 
                            height="1080"
                            class="w-full h-full object-cover object-center animate-subtle-zoom"
                            
                            {/* OPTIMASI LCP: Slide pertama Eager & High Priority, sisanya Lazy */}
                            loading={index === 0 ? "eager" : "lazy"} 
                            fetchpriority={index === 0 ? "high" : "low"}
                            decoding={index === 0 ? "sync" : "async"}
                            
                            onError={(e) => { e.target.src = "https://via.placeholder.com/1920x1080?text=Image+Not+Found"; }}
                        />
                    </div>

                    {/* Gradient Overlay */}
                    <div class="absolute inset-0 bg-gradient-to-r from-slate-900/90 via-slate-900/40 to-transparent z-10"></div>
                    <div class="absolute inset-0 bg-gradient-to-t from-slate-900/80 via-transparent to-transparent z-10 md:hidden"></div>

                    {/* --- KONTEN --- */}
                    <div class="relative z-20 container mx-auto px-6 md:px-24 h-full flex flex-col justify-center">
                        {/* Menambahkan pb-32 di mobile agar teks tidak terlalu ke bawah dan tertutup quick link */}
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-center h-full pt-20 pb-32 lg:pb-0 lg:py-0">
                            
                            <div class="lg:col-span-8 flex flex-col justify-center text-center lg:text-left">
                                {slide.title_small && (
                                    <span class="text-white text-lg md:text-xl lg:text-2xl font-bold tracking-wide mb-3 block drop-shadow-md animate-fade-in-up">
                                        {slide.title_small}
                                    </span>
                                )}
                                
                                <h2 class="text-white text-[10vw] md:text-[4.5rem] lg:text-[6.5rem] leading-[1] font-extrabold tracking-tight drop-shadow-xl animate-fade-in-up delay-100 uppercase mb-6">
                                    {slide.title_big}
                                </h2>

                                {slide.description && (
                                    <p class="text-white/90 text-base md:text-lg font-medium leading-relaxed max-w-2xl mx-auto lg:mx-0 drop-shadow-md lg:border-l-4 lg:border-white/30 lg:pl-5 animate-fade-in-up delay-200 mb-8">
                                        {slide.description}
                                    </p>
                                )}
                                
                                {slide.button_text && (
                                    <div class="flex justify-center lg:justify-start animate-fade-in-up delay-300">
                                        <a 
                                            href={slide.button_link || '#'} 
                                            class="inline-flex bg-nasa-red hover:bg-red-700 text-white px-7 py-3.5 md:px-8 md:py-4 rounded-sm font-bold tracking-wider uppercase transition duration-300 items-center gap-2 shadow-lg"
                                            aria-label={`Tombol ${slide.button_text}`} 
                                        >
                                            {slide.button_text}
                                        </a>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                </div>
            ))}
        </div>
        
        {/* 3. PAGINATION THUMBNAIL (Diposisikan lebih tinggi: bottom-28) */}
        {/* Menggunakan bottom-28 (112px) agar tidak tertutup -mt-16 (64px) dari Quick Links */}
        <div class="absolute bottom-28 right-6 md:bottom-28 md:right-12 z-50 flex items-center gap-4">
            <div class="flex items-center gap-2 md:gap-3 bg-black/40 backdrop-blur-md p-2 rounded-full border border-white/10 shadow-2xl">
                
                {slides.map((slide, index) => (
                    <button 
                        data-index={index} 
                        class="custom-pagination-btn opacity-50 relative w-10 h-10 md:w-12 md:h-12 rounded-full overflow-hidden border-2 border-transparent hover:border-white hover:opacity-100 transition-all cursor-pointer"
                        aria-label={`Go to slide ${index + 1}`}
                    >
                        {/* Lingkaran SVG (Progress Ring) */}
                        <svg class="absolute inset-0 w-full h-full progress-ring" viewBox="0 0 50 50">
                            <circle 
                                class="progress-ring-circle" 
                                stroke="white" 
                                stroke-width="2" 
                                fill="transparent" 
                                r="23" 
                                cx="25" 
                                cy="25" 
                                style="stroke-dasharray: 144.5; stroke-dashoffset: 144.5;"
                            ></circle>
                        </svg>
                        {/* Thumbnail Foto Slide */}
                        {/* Thumbnail diload malas (lazy) agar tidak mengganggu LCP gambar utama */}
                        <img 
                            src={slide.image_url} 
                            alt={`Thumbnail ${index + 1}`} 
                            class="w-full h-full object-cover"
                            loading="lazy"
                        >
                    </button>
                ))}

            </div>
        </div>
        
    </div>
</section>

<style>
    .bg-nasa-red { background-color: #E03C31; }

    @keyframes subtle-zoom { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }
    .animate-subtle-zoom { animation: subtle-zoom 20s ease-in-out infinite alternate; }

    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in-up { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; }
    .delay-100 { animation-delay: 0.1s; } 
    .delay-200 { animation-delay: 0.3s; } 
    .delay-300 { animation-delay: 0.5s; }

    .progress-ring-circle {
        transition: stroke-dashoffset 0.05s linear;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }
</style>

<script>
    import Swiper from 'swiper';
    import { Autoplay } from 'swiper/modules';

    const initSwiper = () => {
        const swiper = new Swiper(".myHeroSwiper", {
            modules: [Autoplay],
            loop: true,
            speed: 1000, 
            autoplay: {
                delay: 6000, 
                disableOnInteraction: false,
                pauseOnMouseEnter: true
            },
            on: {
                autoplayTimeLeft(s, time, progress) {
                    const activeIndex = s.realIndex; 
                    const buttons = document.querySelectorAll('.custom-pagination-btn');
                    
                    buttons.forEach((btn, idx) => {
                        const circle = btn.querySelector('.progress-ring-circle') as SVGCircleElement;
                        if (circle) {
                            if (idx === activeIndex) {
                                circle.style.strokeDashoffset = (144.5 * progress).toString();
                                btn.classList.remove('opacity-50', 'border-transparent');
                                btn.classList.add('border-white', 'opacity-100');
                            } else {
                                circle.style.strokeDashoffset = '144.5';
                                btn.classList.add('opacity-50', 'border-transparent');
                                btn.classList.remove('border-white', 'opacity-100');
                            }
                        }
                    });
                },
                slideChange(s) {
                    const activeIndex = s.realIndex;
                    const buttons = document.querySelectorAll('.custom-pagination-btn');
                    buttons.forEach((btn, idx) => {
                        if (idx !== activeIndex) {
                            const circle = btn.querySelector('.progress-ring-circle') as SVGCircleElement;
                            if (circle) circle.style.strokeDashoffset = '144.5';
                            btn.classList.add('opacity-50', 'border-transparent');
                            btn.classList.remove('border-white', 'opacity-100');
                        }
                    });
                }
            }
        });

        const buttons = document.querySelectorAll('.custom-pagination-btn');
        buttons.forEach((btn) => {
            btn.addEventListener('click', () => {
                const idx = parseInt(btn.getAttribute('data-index') || '0');
                swiper.slideToLoop(idx); 
            });
        });
    };

    document.addEventListener('astro:page-load', initSwiper);
    initSwiper();
</script>